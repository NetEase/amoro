
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

import{d as D,M as R,s as L,b as n,o as r,j as M,B as i,z as v,c as b,a1 as q,l as _,_ as K,e as B,w as I,a as U,D as V,G,N as E,r as j,Z as H,a5 as z,V as F,J,Y as O}from"./index-7UdTOOsH.js";import{u as f}from"./common.type-LfySSiiQ.js";import{o as Y,p as Z}from"./table.service-t8OmEx3P.js";const A={class:"hive-table-detail g-flex"},P={class:"left-content"},Q={key:0,class:"table-attrs"},W={class:"attr-title"},X={class:"table-attrs"},x={class:"attr-title"},ee=D({__name:"Details",props:{schema:{},partitionColumnList:{}},setup(e){const{t}=R(),l=L([{title:t("field"),dataIndex:"field",width:"30%"},{title:t("type"),dataIndex:"type",width:"30%"},{title:t("description"),dataIndex:"comment",ellipsis:!0}]),s=L([{title:t("field"),dataIndex:"field",width:"30%"},{title:t("type"),dataIndex:"type",width:"30%"},{title:t("description"),dataIndex:"comment",ellipsis:!0}]),o=e;return(c,a)=>{const d=n("a-table");return r(),M("div",A,[i("div",P,[o.partitionColumnList&&o.partitionColumnList.length?(r(),M("div",Q,[i("p",W,v(c.$t("partitionKey")),1),b(d,{rowKey:"field",columns:q(s),"data-source":o.partitionColumnList,pagination:!1},null,8,["columns","data-source"])])):_("",!0),i("div",X,[i("p",x,v(c.$t("schema")),1),b(d,{rowKey:"field",columns:q(l),"data-source":o.schema,pagination:!1},null,8,["columns","data-source"])])])])}}}),te=K(ee,[["__scopeId","data-v-7bbd749d"]]),ae={class:"msg"},se=D({__name:"ErrorMsg",props:{msg:{}},emits:["cancle"],setup(e,{emit:t}){const l=e,s=t;return(o,c)=>{const a=n("a-modal");return r(),B(a,{visible:!0,width:560,title:`${o.$t("errorMessage")}`,footer:null,onCancel:c[0]||(c[0]=d=>s("cancle")),class:"upgrade-error"},{default:I(()=>[i("p",ae,v(l.msg),1)]),_:1},8,["title"])}}}),oe=K(se,[["__scopeId","data-v-079bc268"]]),ne=D({name:"Tables",components:{UDetails:te,errorMsg:oe},setup(){const e=f,t=U(),l=V(),s=G(),{t:o}=R(),c=E(()=>s.path.indexOf("upgrade")>-1),a=j({loading:!1,showErrorMsg:!1,activeKey:"Details",status:"",displayStatus:"",errorMessage:"",tableName:"tableName",partitionColumnList:[],schema:[]}),d=()=>{l.back()},g=E(()=>({...s.query})),N=async(p=!1)=>{try{t.value&&clearTimeout(t.value);const{catalog:m,db:w,table:C}=g.value;if(!m||!w||!C)return;!p&&(a.loading=!0);const $=await Y({...g.value}),{status:u,errorMessage:k}=$;a.status=u,a.displayStatus=u===f.upgrading?o("upgrading"):o("upgrade"),a.errorMessage=k||"",u===f.upgrading?t.value=setTimeout(()=>{N(!0)},1500):u===f.none?S():u===f.success?l.replace({path:"/tables",query:{...s.query}}):u===f.failed&&S()}finally{!p&&(a.loading=!1)}},S=async()=>{try{const{catalog:p,db:m,table:w}=g.value;if(!p||!m||!w)return;a.loading=!0;const C=await Z({...g.value}),{partitionColumnList:$=[],schema:u,tableIdentifier:k}=C;a.tableName=(k==null?void 0:k.tableName)||"",a.partitionColumnList=$||[],a.schema=u||[]}catch{}finally{a.loading=!1}},h=async()=>{await N()},T=()=>{l.push({path:"/hive-tables/upgrade",query:{...s.query}})},y=()=>{h()};return H(()=>s.query,(p,m)=>{const{catalog:w,db:C,table:$}=p;s.path==="/hive-tables"&&(w!==m.catalog||C!==m.db||$!==m.table)&&h()}),z(()=>{clearTimeout(t.value)}),F(()=>{h()}),{...J(a),isSecondaryNav:c,upgradeStatus:e,upgradeTable:T,goBack:d,refresh:y}}}),re={class:"hive-tables-wrap"},ie={key:0,class:"tables-content"},le={class:"g-flex-jsb table-top"},ce=["title"],ue={class:"right-btn"},de={class:"content"};function pe(e,t,l,s,o,c){const a=n("a-button"),d=n("u-details"),g=n("a-tab-pane"),N=n("a-tabs"),S=n("u-loading"),h=n("router-view"),T=n("error-msg");return r(),M("div",re,[e.isSecondaryNav?_("",!0):(r(),M("div",ie,[i("div",le,[i("span",{title:e.tableName,class:"table-name g-text-nowrap"},v(e.tableName),9,ce),i("div",ue,[b(a,{type:"primary",disabled:e.status===e.upgradeStatus.upgrading,onClick:e.upgradeTable},{default:I(()=>[O(v(e.displayStatus),1)]),_:1},8,["disabled","onClick"]),e.status===e.upgradeStatus.failed?(r(),M("p",{key:0,onClick:t[0]||(t[0]=y=>e.showErrorMsg=!0),class:"fail-msg"},v(e.$t("lastUpgradingFailed")),1)):_("",!0)])]),i("div",de,[b(N,{activeKey:e.activeKey,"onUpdate:activeKey":t[1]||(t[1]=y=>e.activeKey=y)},{default:I(()=>[b(g,{key:"Details",tab:"Details"},{default:I(()=>[b(d,{partitionColumnList:e.partitionColumnList,schema:e.schema},null,8,["partitionColumnList","schema"])]),_:1})]),_:1},8,["activeKey"])])])),e.loading?(r(),B(S,{key:1})):_("",!0),e.isSecondaryNav?(r(),B(h,{key:2,onGoBack:e.goBack,onRefresh:e.refresh},null,8,["onGoBack","onRefresh"])):_("",!0),e.showErrorMsg?(r(),B(T,{key:3,msg:e.errorMessage,onCancle:t[2]||(t[2]=y=>e.showErrorMsg=!1)},null,8,["msg"])):_("",!0)])}const _e=K(ne,[["render",pe],["__scopeId","data-v-789fb858"]]);export{_e as default};
