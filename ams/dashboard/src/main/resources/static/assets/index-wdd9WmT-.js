
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

import{d as U,Z as oe,a5 as le,V as ue,n as we,o as a,j as d,y as V,ae as $e,af as Q,ag as ne,_ as A,N as ae,B as l,e as y,a1 as E,ah as ie,l as q,C as W,ai as re,z as k,x as z,F as I,v as T,a as f,T as M,r as B,s as Le,$ as N,b as _,c as S,w as F,i as Oe,Q as Re,Y as Ie}from"./index-7UdTOOsH.js";import{d as ce}from"./common.type-LfySSiiQ.js";import{g as Me}from"./table.service-t8OmEx3P.js";import{u as Te}from"./usePlaceholder-oV8njzjL.js";const De={theme:"arcticSql",language:"sql",fontSize:12,lineHeight:24,fontFamily:'Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace',folding:!0,suggestLineHeight:20,autoIndent:!0,renderLineHighlight:"all",scrollBeyondLastLine:!1,contextmenu:!1,readOnly:!0,fixedOverflowWidgets:!0},He=Object.assign({},De,{theme:"arcticSql",language:"sql",readOnly:!1,lineHeight:24,fontSize:12,fontFamily:'Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace',lineNumbersMinChars:3,wordWrap:"on",renderLineHighlight:"all",minimap:{enabled:!1},contextmenu:!1,automaticLayout:!0,scrollBeyondLastLine:!1}),Ee=U({__name:"index",props:{sqlValue:{},options:{},readOnly:{type:Boolean}},emits:["save","update:value","change"],setup(e,{expose:s,emit:g}){let n;const r=e;let h="";const v={},o=g;oe(()=>r.sqlValue,i=>{i&&h!==i&&n&&n.setValue(i)}),window.addEventListener("resize",c);function c(){n&&n.layout()}s({executeCommand(i){const m=v[i],$=n;m&&$&&$._commandService.executeCommand(m)},updateOptions(i={}){n&&n.updateOptions(i)}}),le(()=>{window.removeEventListener("resize",c),n&&n.dispose()}),ue(()=>{const i=document.getElementsByClassName("m-sql-editor")[0];we(()=>{const m=n=$e.create(i,{...He,...r.options});C(),m.setValue(r.sqlValue||""),m.onDidChangeModelContent($=>{const b=n.getValue();o("update:value",b),o("change",b),h=b})})});function C(){if(n){const i=n.addCommand(Q.CtrlCmd|ne.KEY_S,()=>{o("save")});v.save=i;const m=n.addCommand(Q.Alt|Q.Shift|ne.KEY_F,()=>{R()});v.format=m}}function R(){const i=n&&n.getAction("editor.action.formatDocument");i&&i.run()}return(i,m)=>(a(),d("div",{class:V(["m-sql-editor",{disabled:i.readOnly}]),style:{height:"100%",width:"100%"}},null,2))}}),Fe=A(Ee,[["__scopeId","data-v-bef1f56a"]]),Ve={class:"sql-result-wrap"},Be={class:"g-ml-8"},Ne={key:0,class:"empty"},ze={key:1,class:"result-wrap"},Ue={class:"ant-table sql-result-table",style:{width:"100%"}},Ae={class:"ant-table-thead"},Pe={class:"ant-table-tbody"},Ke=["title"],Ye=U({__name:"sql-result",props:{info:{}},setup(e){const s=e,g=ae(()=>{var r;return!s.info||!((r=s.info)!=null&&r.columns)}),n=ae(()=>{var r;return(r=s.info)==null?void 0:r.status});return(r,h)=>(a(),d("div",Ve,[l("div",{class:"result-status",style:z({background:E(ce)[n.value]})},[n.value==="Running"?(a(),y(E(ie),{key:0,style:{color:"#1890ff"}})):q("",!0),n.value==="Canceled"||n.value==="Failed"?(a(),y(E(W),{key:1,style:{color:"#ff4d4f"}})):q("",!0),n.value==="Finished"?(a(),y(E(re),{key:2,style:{color:"#52c41a"}})):q("",!0),n.value==="Created"?(a(),y(E(W),{key:3,style:{color:"#333"}})):q("",!0),l("span",Be,k(n.value),1)],4),g.value?(a(),d("div",Ne,k(r.$t("noResult")),1)):(a(),d("div",ze,[l("table",Ue,[l("thead",Ae,[l("tr",null,[(a(!0),d(I,null,T(s.info.columns,v=>(a(),d("th",{key:v},k(v),1))),128))])]),l("tbody",Pe,[(a(!0),d(I,null,T(s.info.rowData,(v,o)=>(a(),d("tr",{key:o+1},[(a(!0),d(I,null,T(v,(c,C)=>(a(),d("td",{key:o+c+C},[l("span",{class:"td-val",title:c},k(c),9,Ke)]))),128))]))),128))])])]))]))}}),je=A(Ye,[["__scopeId","data-v-e8a379fd"]]),Qe={class:"sql-log"},We=["innerHTML"],Je=U({__name:"sql-log",setup(e,{expose:s}){const g=f("");return s({initData(n){g.value=n}}),(n,r)=>(a(),d("div",Qe,[l("div",{innerHTML:g.value,style:{"white-space":"pre-wrap","font-size":"12px"}},null,8,We)]))}}),Ze=A(Je,[["__scopeId","data-v-14634a89"]]);function Ge(e){return M.get(`ams/v1/terminal/${e}/result`)}function Xe(){return M.get("ams/v1/terminal/examples")}function xe(e){return M.get(`ams/v1/terminal/examples/${e}`)}function et(e){const{catalog:s,sql:g}=e;return M.post(`ams/v1/terminal/catalogs/${s}/execute`,{sql:g})}function tt(e){return M.put(`ams/v1/terminal/${e}/stop`)}function st(e){return M.get(`ams/v1/terminal/${e}/logs`)}function nt(){return M.get("ams/v1/terminal/latestInfos")}const at=U({name:"Terminal",components:{SqlEditor:Fe,SqlResult:je,SqlLog:Ze,CheckCircleOutlined:re,CloseCircleOutlined:W,LoadingOutlined:ie},setup(){const e=B(Te()),s=f(!1),g=f(null),n=f(null),r=f(!1),h=f(""),v=f(!1),o=f(""),c=f(),C=f(!1),R=f(!1),i=f("log"),m=B([]),$=B([]),b=f(""),w=f(),L=B([]),u=f(476),P=Le(ce),J="easylake-sql-source",Z="easylake-use-catalog";oe(()=>r,()=>{g.value.updateOptions({readOnly:r})});const de=t=>{if(t==="debug"){he();return}if(t==="format"){g.value&&g.value.executeCommand("format");return}t==="pause"&&ye()},ge=async()=>{if((await Me()||[]).forEach(p=>{m.push({value:p.catalogName,label:p.catalogName})}),m.length){const p=se(Z),O=m.findIndex(j=>j.value===p);b.value=O>-1?p:m[0].value}},ve=async()=>{const t=await Xe();$.push(...t||[])},me=()=>{te(Z,b.value)},pe=()=>{C.value=!C.value},fe=()=>{R.value=!R.value},K=()=>{L.length=0,n.value.initData("")},he=async()=>{try{if(!b.value){N.error(e.selectClPh);return}v.value=!0,K(),o.value="Running";const t=await et({catalog:b.value,sql:h.value});c.value=t.sessionId||"0",Y()}catch(t){o.value="Failed",N.error(t.message||"error")}},ye=async()=>{c.value&&(i.value="log",w.value&&clearTimeout(w.value),v.value=!1,o.value="Canceling",K(),r.value=!0,await tt(c.value).then(()=>{o.value="Canceled"}).catch(()=>{o.value="Failed"}).finally(()=>{r.value=!1}))},Ce=async()=>{try{L.length=0;const t=await Ge(c.value||"0");t&&t.length&&L.push(...t)}catch{}},Y=async()=>{if(w.value&&clearTimeout(w.value),o.value==="Running"&&c.value){const t=await st(c.value);i.value="log";const{logStatus:p,logs:O}=t||{};if(O!=null&&O.length&&n.value.initData(O.join(`
`)),o.value!=="Canceled"&&(o.value=p),await Ce(),p==="Finished"||p==="Canceled")L.length&&(i.value=L[0].id);else{if(o.value==="Canceled")return;w.value=setTimeout(()=>{Y()},1500)}}},be=async t=>{try{if(i.value="log",o.value==="Running")return;clearTimeout(w.value),s.value=!0;const p=await xe(t);h.value=h.value+`
-- SQL shortcut generated
`+p,v.value=!1,o.value="",K()}catch(p){N.error(p.message)}finally{s.value=!1}},_e=()=>document.body,qe=async()=>{try{g.value&&(h.value=se(J)),s.value=!0;const t=await nt();c.value=t.sessionId,t.sessionId>"0"&&(g.value&&!h.value&&(h.value=t.sql||""),o.value="Running",v.value=!0,Y())}catch(t){N.error(t.message)}finally{s.value=!1}},D={topbarHeight:48,optionHeight:44,resultTabHeight:40,runStatusHeight:32,gap:48};let G=0,X=0;const Se=t=>{G=t.clientY,X=u.value,window.addEventListener("mousemove",x),window.addEventListener("mouseup",ee)},x=t=>{const O=t.clientY-G,j=C.value?0:D.topbarHeight,ke=o.value?D.runStatusHeight:0;let H=X+O;H=Math.max(H,D.optionHeight+ke),H=Math.min(H,window.innerHeight-j-(C.value?0:D.gap)-D.optionHeight-4),u.value=H},ee=()=>{window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",ee)},te=(t,p)=>{localStorage.setItem(t,p)},se=t=>localStorage.getItem(t)||"";return le(()=>{clearTimeout(w.value),te(J,h.value),console.log("onBeforeUnmount",h.value)}),ue(()=>{qe(),ve(),ge()}),{loading:s,bgcMap:P,sqlLogRef:n,sqlEditorRef:g,fullscreen:C,resultFullscreen:R,operationActive:i,resultTabList:L,runStatus:o,shortcuts:$,curCatalog:b,catalogOptions:m,handleIconClick:de,handleFull:pe,resultFull:fe,showDebug:v,sqlSource:h,readOnly:r,generateCode:be,getPopupContainer:_e,sqlResultHeight:u,dragMounseDown:Se,changeUseCatalog:me}}}),ot={class:"console-wrap"},lt={class:"sql-block"},ut={class:"top-ops g-flex-jsb"},it={class:"title-left g-flex-ac"},rt={class:"select-catalog g-mr-12"},ct={class:"label"},dt={class:"title-right"},gt={class:"sql-content"},vt={class:"sql-raw"},mt={class:"g-ml-12"},pt={class:"sql-shortcuts"},ft={class:"shortcuts"},ht={class:"tab-operation"},yt={class:"tab"},Ct=["onClick"],bt={class:"debug-result"};function _t(e,s,g,n,r,h){const v=_("a-select"),o=_("svg-icon"),c=_("a-tooltip"),C=_("sql-editor"),R=_("loading-outlined"),i=_("close-circle-outlined"),m=_("check-circle-outlined"),$=_("a-button"),b=_("sql-log"),w=_("sql-result"),L=_("u-loading");return a(),d("div",ot,[l("div",{class:V(["console-content",{fullscreen:e.fullscreen}])},[l("div",{style:z({height:`${e.sqlResultHeight}px`}),class:"sql-wrap"},[l("div",lt,[l("div",ut,[l("div",it,[l("div",rt,[l("span",ct,k(e.$t("use")),1),S(v,{value:e.curCatalog,"onUpdate:value":s[0]||(s[0]=u=>e.curCatalog=u),style:{width:"200px"},options:e.catalogOptions,onChange:e.changeUseCatalog},null,8,["value","options","onChange"])]),e.runStatus==="Running"?(a(),y(c,{key:0,title:e.$t("pause"),placement:"bottom"},{default:F(()=>[S(o,{className:"icon-svg","icon-class":"sqlpause",onClick:s[1]||(s[1]=u=>e.handleIconClick("pause")),class:"g-mr-12",disabled:e.readOnly},null,8,["disabled"])]),_:1},8,["title"])):(a(),y(c,{key:1,title:e.$t("run"),placement:"bottom"},{default:F(()=>[S(o,{className:"icon-svg","icon-class":"sqldebug",onClick:s[2]||(s[2]=u=>e.handleIconClick("debug")),class:"g-mr-12",disabled:e.readOnly},null,8,["disabled"])]),_:1},8,["title"])),S(c,{title:e.$t("format"),placement:"bottom"},{default:F(()=>[S(o,{className:"icon-svg",isStroke:!0,"icon-class":"format",onClick:s[3]||(s[3]=u=>e.handleIconClick("format")),disabled:e.readOnly},null,8,["disabled"])]),_:1},8,["title"])]),l("div",dt,[S(c,{title:e.fullscreen?e.$t("recovery"):e.$t("fullscreen"),placement:"bottom",getPopupContainer:e.getPopupContainer},{default:F(()=>[S(o,{className:"icon-svg",isStroke:!0,"icon-class":e.fullscreen?"sqlinit":"sqlmax",onClick:e.handleFull,disabled:!1,class:"g-ml-12"},null,8,["icon-class","onClick"])]),_:1},8,["title","getPopupContainer"])])]),l("div",gt,[l("div",vt,[S(C,{ref:"sqlEditorRef",sqlValue:e.sqlSource,value:e.sqlSource,"onUpdate:value":s[4]||(s[4]=u=>e.sqlSource=u),readOnly:e.readOnly,options:{readOnly:e.readOnly,minimap:{enabled:!1}}},null,8,["sqlValue","value","readOnly","options"])]),e.runStatus?(a(),d("div",{key:0,class:"run-status",style:z({background:e.bgcMap[e.runStatus]})},[e.runStatus==="Running"||e.runStatus==="Canceling"?(a(),y(R,{key:0,style:{color:"#1890ff"}})):q("",!0),e.runStatus==="Canceled"||e.runStatus==="Failed"?(a(),y(i,{key:1,style:{color:"#ff4d4f"}})):q("",!0),e.runStatus==="Finished"?(a(),y(m,{key:2,style:{color:"#52c41a"}})):q("",!0),e.runStatus==="Created"?(a(),y(i,{key:3,style:{color:"#333"}})):q("",!0),l("span",mt,k(e.$t(e.runStatus)),1)],4)):q("",!0)])]),l("div",pt,[l("div",ft,k(e.$t("sqlShortcuts")),1),(a(!0),d(I,null,T(e.shortcuts,u=>(a(),y($,{key:u,type:"link",disabled:e.runStatus==="Running"||e.runStatus==="Canceling",onClick:P=>e.generateCode(u),class:"code"},{default:F(()=>[Ie(k(u),1)]),_:2},1032,["disabled","onClick"]))),128))])],4),l("div",{class:V(["sql-result",e.resultFullscreen?"result-full":""]),style:z({height:`calc(100% - ${e.sqlResultHeight}px)`})},[l("span",{class:"drag-line",onMousedown:s[5]||(s[5]=(...u)=>e.dragMounseDown&&e.dragMounseDown(...u))},[S(o,{class:"icon","icon-class":"slide"})],32),l("div",ht,[l("div",yt,[l("span",{class:V([{active:e.operationActive==="log"},"tab-item"]),onClick:s[6]||(s[6]=u=>e.operationActive="log")},k(e.$t("log")),3),(a(!0),d(I,null,T(e.resultTabList,u=>(a(),d("span",{key:u.id,class:V([{active:e.operationActive===u.id},"tab-item"]),onClick:P=>e.operationActive=u.id},k(u.id),11,Ct))),128))])]),l("div",bt,[Oe(S(b,{ref:"sqlLogRef"},null,512),[[Re,e.operationActive==="log"]]),(a(!0),d(I,null,T(e.resultTabList,u=>(a(),d(I,{key:u.id},[e.operationActive===u.id?(a(),y(w,{key:0,info:u},null,8,["info"])):q("",!0)],64))),128))])],6)],2),e.loading?(a(),y(L,{key:0})):q("",!0)])}const $t=A(at,[["render",_t],["__scopeId","data-v-79f83ea9"]]);export{$t as default};
